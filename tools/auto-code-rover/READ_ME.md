# Evaluations on the Effectiveness of LM Tools with CI-Bench 
This is a modified version of Auto-Code-Rover to produce patch for bugswarm artifact.

The paper for auto-code-rover: https://arxiv.org/pdf/2404.05427
Github link for main code base: https://github.com/nus-apr/auto-code-rover?tab=readme-ov-file

We will test the efficacy of tool using `tananaev-traccar-64783123` as an example artifact. It is a Java artifact and from github, we come to know its diff size is 2.

# Setting up the Auto-Code-Rover

1. Clone the repository
```bash
git clone https://github.com/BugSwarm/CIFailureFix-Agent.git
```

2. Go inside `CIFailureFix-Agent/auto-code-rover`
```bash
cd CIFailureFix-Agent/auto-code-rover
```

3. Build a docker image named acr
```bash
docker build -f Dockerfile.minimal -t acr .
```

3. Enter into the docker container
```bash
docker run -it -v /var/run/docker.sock:/var/run/docker.sock acr
```

4. Activate the auto-code-rover environment, export BUGSWARM_TOKEN
```bash
conda activate auto-code-rover
export BUGSWARM_TOKEN={bugswarm_token}
```

5. Export your prefered model key. 

For example, If you want to use Openai model, export its key 

```bash
export OPENAI_KEY={your_key}
```

or, if you want to use anthropic model, use its key
```bash
export ANTHROPIC_API_KEY={your_key}
```

# Running python script for generating the patch

1. For generating patch
```bash
PYTHONPATH=. python app/main.py bugswarm-task --output-dir <output_folder> --setup-dir <setup_folder> --model <llm_model_name> --model-temperature <temperature> --bugswarm-image-tag <bugswarm_artifact_name>
```
output_folder - where results and trajectories are saved
setup_folder - where repo is saved

For BugSwarm image we are using `tananaev-traccar-185965292`

<llm_model_name> refers the model name

command will be
```bash
PYTHONPATH=. python app/main.py bugswarm-task --output-dir output --setup-dir setup --model gpt-4o-2024-05-13 --model-temperature 0.2 --bugswarm-image-tag tananaev-traccar-185965292
```

After running the command, a patch will be generated

```
─ AutoCodeRover (extracted patch) ────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                      │
│  diff --git a/src/org/traccar/database/ConnectionManager.java b/src/org/traccar/database/ConnectionManager.java      │
│  index eb81c9ad..9e4b65b2 100644                                                                                     │
│  --- a/src/org/traccar/database/ConnectionManager.java                                                               │
│  +++ b/src/org/traccar/database/ConnectionManager.java                                                               │
│  @@ -29,7 +29,6 @@ import org.traccar.model.Position;                                                                │
│   import java.net.SocketAddress;                                                                                     │
│   import java.sql.SQLException;                                                                                      │
│   import java.util.Date;                                                                                             │
│  -import java.util.HashMap;                                                                                          │
│   import java.util.HashSet;                                                                                          │
│   import java.util.Map;                                                                                              │
│   import java.util.Set;                                                                                              │
│                                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

[2024-12-21 08:32:32] Task tananaev-traccar-185965292 completed successfully.

[2024-12-21 08:32:32] Please find the generated patch at: 
/opt/auto-code-rover/output/tananaev-traccar-185965292_2024-12-21_08-31-10/final_patch.diff

[2024-12-21 08:32:32] Finished all tasks sequentially.
```


# Testing the patch generated by CIFailureFix-Agent(optional):

We will test the generated patch with our hands. At first, we have to come out from the docker container. Let's follow the steps:

1. We have to find out the container id using this

```bash
docker ps -a
```

After executing this, we will get a list of the containers running. Note the container IDs for the acr container and the `bugswarm/cached-images` container.

```
CONTAINER ID   IMAGE                                                COMMAND                  CREATED        STATUS       PORTS     NAMES
bf8a87732cca   bugswarm/cached-images:tananaev-traccar-187574671    "tail -f /dev/null"      8 hours ago    Up 8 hours   22/tcp tananaev-traccar-187574671
34a8853e0122   acr                                                  "/bin/bash"              8 hours ago    Exited (129) 4 hours ago             pensive_newton
```

2. Copy the patch file from the acr container. We get the patch file path from the output of auto-code-rover

```bash
docker cp <acr_container_id>:<patch_file_path> .
```
After that, copy the patch file into bugswarm container failed path

```bash
docker cp <patch_file> <bugswarm_container_id>:<failed_repo_path>
```

3. After getting the container id, we will enter into the container

```bash
docker exec -it <container_id> /bin/bash
```

4. Go into failed repo, clean the repo and apply the patch
```bash
cd <failed_repo_path>
git clean -fdx
git apply <patch_file>
```


5. Run the script to build the repo to see if the build process is successful 

```bash
run_failed.sh
```